<!DOCTYPE html>
<html>
<head>
  <title>Welcome to PawFridge!</title>
  <link rel="stylesheet" href="./styles.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9LYYYZ9ZDD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-9LYYYZ9ZDD');
  </script>
  <script>
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(String(email).toLowerCase());
    }

    function validateDate(date) {
      return !isNaN(Date.parse(date));
    }

    $(document).ready(function() {
      // Validate new user form
      $('#add-user-form').submit(function(event) {
        const userID = $('input[name="user_id"]').val();
        const email = $('input[name="email"]').val();

        if (userID.length > 20) {
          alert("Please limit the user ID to 20 characters.");
          event.preventDefault();
          return false;
        }

        if (email && !validateEmail(email)) {
          alert("Please make sure this is a valid email address.");
          event.preventDefault();
          return false;
        }

        var form = $(this);
        var userAddedCue = document.getElementById("user-added-cue");
    
        $.ajax({
          type: form.attr('method'),
          url: form.attr('action'),
          data: form.serialize(),
          success: function() {
            userAddedCue.style.visibility = "visible";
            setTimeout(function() {
              userAddedCue.style.visibility = "hidden";
            }, 3000); // Hide after 3 seconds
            console.log("Fetching updated user list...");
            fetchUserIDs(selectedUserID); // Reload user list to include the new user
          }
        });
      });

      // Validate new fridge form
      $('#add-fridge-form').submit(function(event) {
        const fridgeName = $('input[name="fridge_name"]').val();

        if (fridgeName.length > 20) {
          alert("Please limit the fridge name to 20 characters.");
          event.preventDefault();
          return false;
        }

        var form = $(this);
        var fridgeAddedCue = document.getElementById("fridge-added-cue");
    
        $.ajax({
          type: form.attr('method'),
          url: form.attr('action'),
          data: form.serialize(),
          success: function() {
            fridgeAddedCue.style.visibility = "visible";
            setTimeout(function() {
              fridgeAddedCue.style.visibility = "hidden";
            }, 3000); // Hide after 3 seconds
            console.log("Fetching updated fridge list...");
            fetchFridgeIDs(selectedFridgeID); // Reload fridge list to include the new fridge
          }
        });
      });

      // Validate add food form
      $('#add-food-form').submit(function(event) {
        const foodName = $('#food-name').val();
        const qty = $('#qty').val();
        const expiryDate = $('#expiry-date').val();
        const note = $('#note').val();

        if (foodName.length > 20) {
          alert("Please limit the food name to 20 characters.");
          event.preventDefault();
          return false;
        }

        if (qty > 10000) {
          alert("Quantity should not exceed 10000.");
          event.preventDefault();
          return false;
        }

        if (!validateDate(expiryDate)) {
          alert("Please enter a valid expiry date.");
          event.preventDefault();
          return false;
        }

        if (note.length > 250) {
          alert("Please limit the note to 250 characters.");
          event.preventDefault();
          return false;
        }

        var selectedFridgeID = $('#fridge-list').val();
        var selectedUserID = $('#user-list').val();

        var formData = {
          food_name: foodName,
          qty: qty,
          compartment: $('#compartment').val(),
          expiry_date: expiryDate,
          note: note,
          discard: $('#discard').is(':checked'),
          fridge_id: selectedFridgeID,
          owner: selectedUserID
        };
  
        $.ajax({
          url: '/add-food',
          type: 'POST',
          data: JSON.stringify(formData),
          contentType: 'application/json',
          success: function(data) {
            console.log('Success:', data);
            fetchFoodData(selectedFridgeID);
            $('#addFoodModal').hide();
            // Clear the form inputs
            $('#food-name').val('');
            $('#qty').val('');
            $('#compartment').val('');
            $('#expiry-date').val('');
            $('#note').val('');
            $('#discard').prop('checked', false);
            // Hide the delete fridge button
            document.getElementById("delete-fridge").style.display = "none";
          },
          error: function(error) {
            console.error('Error adding food item:', error);
          }
        });
      });

      // Validate edit food form
      $('#edit-food-form').submit(function(event) {
        const foodName = $('#edit-food-name').val();
        const qty = $('#edit-qty').val();
        const expiryDate = $('#edit-expiry-date').val();
        const note = $('#edit-note').val();

        if (foodName.length > 20) {
          alert("Please limit the food name to 20 characters.");
          event.preventDefault();
          return false;
        }

        if (qty > 10000) {
          alert("Quantity should not exceed 10000.");
          event.preventDefault();
          return false;
        }

        if (!validateDate(expiryDate)) {
          alert("Please enter a valid expiry date.");
          event.preventDefault();
          return false;
        }

        if (note.length > 250) {
          alert("Please limit the note to 250 characters.");
          event.preventDefault();
          return false;
        }

        var selectedFoodItem = $('input[name="food-item"]:checked').val();

        var formData = {
          food_name: foodName,
          qty: qty,
          compartment: $('#edit-compartment').val(),
          expiry_date: expiryDate,
          note: note,
          discard: $('#edit-discard').prop('checked'),
          food_id: selectedFoodItem,
          owner: selectedUserID
        };
  
        $.ajax({
          url: '/edit-food',
          type: 'POST',
          data: JSON.stringify(formData),
          contentType: 'application/json',
          success: function(data) {
            console.log('Success:', data);
            fetchFoodData(selectedFridgeID);
            $('#editFoodModal').hide();
            // Check if fridge is empty and show/hide the delete fridge button
            checkFridgeEmpty(selectedFridgeID);
          },
          error: function(error) {
            console.error('Error editing food item:', error);
          }
        });
      });

      // Delete food modal function
      $('#delete').click(function() {
        var selectedFoodItem = $('input[name="food-item"]:checked').val();
  
        if (!selectedFoodItem) {
          alert('Please select a food item to delete');
          return;
        }
  
        $('#deleteFoodModal').show();
  
        $('#confirm-delete').click(function() {
          $.ajax({
            url: '/delete-food',
            type: 'POST',
            data: JSON.stringify({ food_id: selectedFoodItem }),
            contentType: 'application/json',
            success: function(data) {
              console.log('Success:', data);
              fetchFoodData(selectedFridgeID);
              $('#deleteFoodModal').hide();
              // Check if fridge is empty and show/hide the delete fridge button
              checkFridgeEmpty(selectedFridgeID);
            },
            error: function(error) {
              console.error('Error deleting food item:', error);
            }
          });
        });
  
        $('#cancel-delete').click(function() {
          $('#deleteFoodModal').hide();
        });
      });

      // Close modal when clicking outside
      window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = "none";
        }
      };
    });

    // Show visual cues for new user and fridge additions
    $('#add-user-form').submit(function(event) {
      event.preventDefault();
      var form = $(this);
      var userAddedCue = document.getElementById("user-added-cue");
  
      $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: form.serialize(),
        success: function() {
          userAddedCue.style.visibility = "visible";
          setTimeout(function() {
            userAddedCue.style.visibility = "hidden";
          }, 3000); // Hide after 3 seconds
          console.log("Fetching updated user list...");
          fetchUserIDs(selectedUserID); // Reload user list to include the new user
        }
      });
    });
  
    $('#add-fridge-form').submit(function(event) {
      event.preventDefault();
      var form = $(this);
      var fridgeAddedCue = document.getElementById("fridge-added-cue");
  
      $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: form.serialize(),
        success: function() {
          fridgeAddedCue.style.visibility = "visible";
          setTimeout(function() {
            fridgeAddedCue.style.visibility = "hidden";
          }, 3000); // Hide after 3 seconds
          console.log("Fetching updated fridge list...");
          fetchFridgeIDs(selectedFridgeID); // Reload fridge list to include the new fridge
        }
      });
    });

    $('#delete-fridge').click(function() {
      if (confirm('Are you sure you want to delete this fridge?')) {
        var selectedFridgeName = $("#fridge-list option:selected").text();
        $.ajax({
          url: '/delete-fridge',
          type: 'POST',
          data: JSON.stringify({ fridge_id: selectedFridgeID }),
          contentType: 'application/json',
          success: function(data) {
            console.log('Fridge deleted:', data);
            var fridgeDeletedCue = document.getElementById("fridge-deleted-cue");
            fridgeDeletedCue.textContent = "Fridge '" + selectedFridgeName + "' successfully deleted!";
            fridgeDeletedCue.style.visibility = "visible";
            setTimeout(function() {
              fridgeDeletedCue.style.visibility = "hidden";
            }, 3000); // Hide after 3 seconds
            document.getElementById("card3").style.display = "none";
            $('#fridge-list').val(''); // Reset fridge selection
            $('#fridge-list').empty(); // Clear the fridge list
            fetchFridgeIDs();
          },
          error: function(error) {
            console.error('Error deleting fridge:', error);
          }
        });
      }
    });
  </script>
</head>
<body>
  <div class="navbar">
    <a href="/">Home</a>
    <a href="/about">About...</a>
    <a href="#contact">Contact</a>
  </div>
  
  <div class="grid-container">
    <div class="welcome_card">
      <h1>Welcome to PawFridge</h1>
      <p>– the convenient and practical solution to managing what's in your fridge. 
      <br>Here's an opportunity to play an active role (for once) in managing your refrigerator. Stretch your paw(s) today, and no more wasted food or forgotten items!</p>
    </div>
  </div>

  <div class="grid-container">
    <div id="card1" class="card">
      <h3>Let's get started ...</h3>
      <p>Choose a user below:</p>
      <select id="user-list"></select>
      <div id="user-selection-cue" class="user-selection-cue"></div>
      <p><br>or sign up as a new user:</p>
      <form id="add-user-form" action="/adduser" method="post">
        <input type="text" name="user_id" placeholder="Enter your name">
        <input type="text" name="email" placeholder="Enter your email (optional)">
        <button class="plan-button" type="submit">Sign up</button>
      </form>
      <div id="user-added-cue" class="success-cue">User added successfully! Please REFRESH (F5) your browser now.</div>
    </div>
  </div>

  <div class="grid-container">
    <div id="card2" class="card" style="display: none;">
      <h3>Choose a fridge below:</h3>
      <select id="fridge-list"></select>
      <div id="fridge-selection-cue" class="fridge-selection-cue"></div>
      <button id="delete-fridge" style="display: none;">Delete Fridge</button>
      <div id="fridge-deleted-cue" class="success-cue">Fridge successfully deleted! Please select a new fridge.</div>
      <p><br>or add a new fridge:</p>
      <form id="add-fridge-form" action="/addfridge" method="post">
        <input type="text" name="fridge_name" placeholder="Enter the name to identify the fridge">
        <input type="number" name="selectedUserID" hidden>
        <button class="plan-button" type="submit">Add</button>
      </form>
      <div id="fridge-added-cue" class="success-cue">Fridge added successfully! Please REFRESH (F5) your browser now.</div>
    </div>
  </div>

  <div class="grid-container">
    <div id="card3" class="card" style="display: none;">
      <h3 id="fridge-content-header">Here's the contents of your fridge</h3>
      <div id="error-message-fridgeID" style="color: red;"></div>
      <button id="add-new">Add new</button>
      <button id="edit">Edit</button>
      <button id="delete">Delete</button>
      <table id="food-table">
        <thead>
          <tr>
            <th>Select</th>
            <th>No.</th>
            <th>Food Name</th>
            <th>Quantity</th>
            <th>Compartment</th>
            <th>Expiry Date</th>
            <th>Note</th>
            <th>Owner</th>
            <th>Ok to discard</th>
          </tr>
        </thead>
        <tbody>
          <!-- Food data will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add New Food Item Modal -->
  <div id="addFoodModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <form id="add-food-form">
        <label for="food-name">Name of food:</label><br>
        <input type="text" id="food-name" name="food_name"><br>
        <label for="qty">Quantity:</label><br>
        <input type="number" id="qty" name="qty"><br>
        <label for="compartment">Compartment:</label><br>
        <select id="compartment" name="compartment">
          <option value="Main fridge">Main fridge</option>
          <option value="Upper shelves">Upper shelves</option>
          <option value="Middle shelves">Middle shelves</option>
          <option value="Bottom shelves">Bottom shelves</option>
          <option value="Freezer">Freezer</option>
          <option value="Door Bins">Door Bins</option>
          <option value="Vegetable/Fruits">Vegetable/Fruits</option>
          <option value="Beverage Rack">Beverage Rack</option>
          <option value="Special Drawer">Special Drawer</option>
          <option value="Others">Others</option>
        </select><br>
        <label for="expiry-date">Expiry date:</label><br>
        <input type="date" id="expiry-date" name="expiry_date"><br>
        <label for="note">Note:</label><br>
        <input type="text" id="note" name="note"><br>
        <label for="discard">OK to discard by others:</label><br>
        <input type="checkbox" id="discard" name="discard">
        <br>
        <input type="submit" value="Submit">
        <input type="button" value="Cancel" id="cancel-add">
      </form>
    </div>
  </div>

  <!-- Edit Food Item Modal -->
  <div id="editFoodModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <form id="edit-food-form">
        <label for="edit-food-name">Name of food:</label><br>
        <input type="text" id="edit-food-name" name="food_name"><br>
        <label for="edit-qty">Quantity:</label><br>
        <input type="number" id="edit-qty" name="qty"><br>
        <label for="edit-compartment">Compartment:</label><br>
        <select id="edit-compartment" name="compartment">
          <option value="Main fridge">Main fridge</option>
          <option value="Upper shelves">Upper shelves</option>
          <option value="Middle shelves">Middle shelves</option>
          <option value="Bottom shelves">Bottom shelves</option>
          <option value="Freezer">Freezer</option>
          <option value="Door Bins">Door Bins</option>
          <option value="Vegetable/Fruits">Vegetable/Fruits</option>
          <option value="Beverage Rack">Beverage Rack</option>
          <option value="Special Drawer">Special Drawer</option>
          <option value="Others">Others</option>
        </select><br>
        <label for="edit-expiry-date">Expiry date:</label><br>
        <input type="date" id="edit-expiry-date" name="expiry_date"><br>
        <label for="edit-note">Note:</label><br>
        <input type="text" id="edit-note" name="note"><br>
        <label for="edit-discard">OK to discard by others:</label><br>
        <input type="checkbox" id="edit-discard" name="discard"><br>
        <input type="submit" value="Submit">
        <input type="button" value="Cancel" id="cancel-edit">
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteFoodModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <p>Are you sure you want to delete this food item?</p>
      <button id="confirm-delete">Yes, delete it</button>
      <button id="cancel-delete">Cancel</button>
    </div>
  </div>

  <div class="footer">
    <p>&copy; PawFridge. All rights reserved.</p>
    <p>Disclaimer: This website is created for learning purposes only. The information provided here should not be considered professional advice. Please note that we make no guarantees regarding the accuracy, completeness, or reliability of the contents of this website. Any actions you take based on the contents of this website are at your own risk. We are not liable for any losses or damages incurred from the use of this website.</p>
  </div>

</body>
</html>
